<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="es">
<head>
    <meta charset="UTF-8">
    <title>Nuevo juego</title>

    <!-- Bootstrap 5 por CDN -->
    <link
            href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
            rel="stylesheet"
            integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
            crossorigin="anonymous"
    >

    <!-- Tu hoja de estilos global -->
    <link rel="stylesheet" th:href="@{/css/app.css}">
</head>
<body class="bg-slate text-light">

<div class="container py-4">

    <!-- Encabezado / breadcrumb simple -->
    <div class="d-flex justify-content-between align-items-center mb-3">
        <div>
            <span class="pill">Backlog de videojuegos</span>
            <h1 class="h3 mb-0">Registrar nuevo juego</h1>
            <small class="text-secondary">
                Completa los datos del juego y tu progreso personal.
            </small>
        </div>
        <div class="text-end">
            <a th:href="@{/}" class="btn btn-outline-light btn-sm mb-1">
                ← Volver al inicio
            </a>
            <br>
            <a th:href="@{/dashboard}" class="btn btn-outline-success btn-sm">
                Ver dashboard
            </a>
        </div>
    </div>

    <!-- Card contenedora del formulario -->
    <div class="card bg-dark text-light shadow">
        <div class="card-body">

            <!--
              IMPORTANTE:
              Este formulario asume que tu controlador MVC hace:

              model.addAttribute("juego", new JuegoDTO());
              model.addAttribute("etiquetas", etiquetaService.listar());

              y expone un POST /juegos que recibe @ModelAttribute JuegoDTO.
            -->
            <form th:action="@{/juegos/guardar}" th:object="${juego}" method="post">
                <input type="hidden" th:field="*{id}"/>

                <!-- ========= Datos generales ========= -->
                <h2 class="h6 text-uppercase text-secondary mb-3">Datos generales</h2>

                <div class="row g-3 mb-3">
                    <div class="col-md-8">
                        <label for="titulo" class="form-label">Título</label>
                        <input id="titulo" type="text" th:field="*{titulo}"
                               class="form-control form-control-sm"
                               placeholder="Ej: Final Fantasy IX" required>
                    </div>
                    <div class="col-md-4">
                        <label for="anio" class="form-label">Año de lanzamiento</label>
                        <input id="anio" type="number" th:field="*{anioLanzamiento}"
                               class="form-control form-control-sm"
                               placeholder="Ej: 2000" min="1970" max="2100">
                    </div>
                </div>

                <div class="row g-3 mb-3">
                    <div class="col-md-6">
                        <label for="desarrollador" class="form-label">Desarrollador</label>
                        <input id="desarrollador" type="text" th:field="*{desarrollador}"
                               class="form-control form-control-sm"
                               placeholder="SquareSoft">
                    </div>
                    <div class="col-md-6">
                        <label for="editora" class="form-label">Editora</label>
                        <input id="editora" type="text" th:field="*{editora}"
                               class="form-control form-control-sm"
                               placeholder="Square">
                    </div>
                </div>

                <div class="row g-3 mb-3">
                    <div class="col-md-6">
                        <label for="genero" class="form-label">Género</label>
                        <input id="genero" type="text" th:field="*{genero}"
                               class="form-control form-control-sm"
                               placeholder="Ej: JRPG, Acción, Aventura">
                    </div>
                    <div class="col-md-6">
                        <label for="plataforma" class="form-label">Plataforma</label>
                        <select id="plataforma" class="form-select form-select-sm"
                                th:field="*{plataforma}">
                            <option value="">Selecciona una plataforma</option>
                            <!-- Cargar todas las constantes del enum Plataforma -->
                            <option th:each="plat : ${T(com.leomar.videojuegos.model.Plataforma).values()}"
                                    th:value="${plat}"
                                    th:text="${plat}">
                            </option>
                        </select>
                    </div>
                </div>

                <div class="mb-3">
                    <label for="descripcion" class="form-label">Descripción</label>
                    <textarea id="descripcion" rows="3" th:field="*{descripcion}"
                              class="form-control form-control-sm"
                              placeholder="Pequeña descripción del juego..."></textarea>
                </div>

                <div class="mb-4">
                    <label for="portada" class="form-label">URL de portada</label>
                    <input id="portada" type="text" th:field="*{portada}"
                           class="form-control form-control-sm"
                           placeholder="Ej: https://mis-imagenes.com/ff9.jpg">
                    <div class="form-text text-secondary">
                        Usa una URL directa a la imagen (JPG/PNG) para que aparezca en el dashboard y en el detalle.
                    </div>
                </div>

                <!-- ========= Progreso personal ========= -->
                <h2 class="h6 text-uppercase text-secondary mb-3">Progreso personal</h2>

                <div class="row g-3 mb-3">
                    <div class="col-md-4">
                        <label for="horasJugadas" class="form-label">Horas jugadas</label>
                        <input id="horasJugadas" type="number" min="0" step="1"
                               th:field="*{horasJugadas}"
                               class="form-control form-control-sm"
                               placeholder="Ej: 40">
                    </div>
                    <div class="col-md-4">
                        <label for="puntaje" class="form-label">Puntaje</label>
                        <input id="puntaje" type="number" min="0" max="10" step="0.1"
                               th:field="*{puntaje}"
                               class="form-control form-control-sm"
                               placeholder="0 - 10">
                    </div>
                    <div class="col-md-4">
                        <label for="estadoTermino" class="form-label">Estado</label>
                        <!-- Si en tu entidad es String, estos valores son solo una guía -->
                        <select id="estadoTermino"
                                class="form-select form-select-sm"
                                th:field="*{estadoTermino}">
                            <option value="">Sin estado</option>
                            <option value="PENDIENTE">Pendiente</option>
                            <option value="JUGANDO">Jugando</option>
                            <option value="COMPLETADO">Completado</option>
                            <option value="ABANDONADO">Abandonado</option>
                        </select>
                    </div>
                </div>

                <div class="mb-4">
                    <label for="notas" class="form-label">Notas personales</label>
                    <textarea id="notas" rows="3" th:field="*{notas}"
                              class="form-control form-control-sm"
                              placeholder="Ej: Lo terminé 2 veces, una en Normal y otra en Difícil."></textarea>
                    <div class="form-text text-secondary">
                        Aquí puedes anotar si lo completaste más de una vez, dificultades, logros, etc.
                    </div>
                </div>

                <!-- ========= Etiquetas ========= -->
                <h2 class="h6 text-uppercase text-secondary mb-3">Etiquetas</h2>

                <!-- Seleccionar etiquetas existentes -->
                <div class="mb-3">
                    <label for="selectEtiquetas" class="form-label">
                        Seleccionar etiquetas existentes
                    </label>
                    <select id="selectEtiquetas"
                            class="form-select form-select-sm"
                            multiple
                            size="5"
                            th:field="*{etiquetasIds}">
                        <option th:each="tag : ${etiquetas}"
                                th:value="${tag.id}"
                                th:text="${tag.nombreEtiqueta}">
                        </option>
                    </select>
                    <div class="form-text text-secondary">
                        Usa CTRL (o CMD en Mac) para seleccionar varias etiquetas.
                    </div>
                </div>

                <!-- Crear etiqueta nueva rápidamente (usa tu API REST /api/etiquetas) -->
                <div class="mb-4">
                    <label for="nuevaEtiqueta" class="form-label">
                        Agregar nueva etiqueta
                    </label>
                    <div class="input-group input-group-sm">
                        <input type="text" id="nuevaEtiqueta"
                               class="form-control"
                               placeholder="Ej: JRPG, Retro, Cooperativo">
                        <button type="button"
                                class="btn btn-outline-success"
                                onclick="agregarEtiqueta()">
                            Añadir
                        </button>
                    </div>
                    <div id="etiquetaMensaje" class="form-text text-warning small mt-1"></div>
                </div>

                <!-- ========= Botones ========= -->
                <div class="d-flex justify-content-end gap-2">
                    <a th:href="@{/}" class="btn btn-outline-secondary btn-sm">
                        Cancelar
                    </a>
                    <button type="submit" class="btn btn-success btn-sm">
                        Guardar juego
                    </button>
                </div>

            </form>
        </div>
    </div>
</div>

<!-- Bootstrap JS (opcional para componentes dinámicos) -->
<script
        src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
        crossorigin="anonymous">
</script>

<!-- JS para crear etiquetas nuevas vía tu API REST -->
<script>
    async function agregarEtiqueta() {
        const input = document.getElementById('nuevaEtiqueta');
        const mensaje = document.getElementById('etiquetaMensaje');
        const nombre = input.value.trim();

        if (!nombre) {
            mensaje.textContent = 'Escribe un nombre para la etiqueta.';
            return;
        }

        try {
            const resp = await fetch('/api/etiquetas', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ nombreEtiqueta: nombre })
            });

            if (!resp.ok) {
                mensaje.textContent = 'No se pudo crear la etiqueta (código ' + resp.status + ').';
                return;
            }

            const nueva = await resp.json();

            // Añadir la nueva etiqueta al select y dejarla seleccionada
            const select = document.getElementById('selectEtiquetas');
            const opt = document.createElement('option');
            opt.value = nueva.id;
            opt.textContent = nueva.nombreEtiqueta;
            opt.selected = true;
            select.appendChild(opt);

            mensaje.textContent = 'Etiqueta "' + nueva.nombreEtiqueta + '" agregada y seleccionada.';
            input.value = '';
        } catch (e) {
            console.error(e);
            mensaje.textContent = 'Error de red al crear la etiqueta.';
        }
    }
</script>

</body>
</html>